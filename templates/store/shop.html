{% extends "store/base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">

    <h1 class="text-4xl font-bold mb-8 text-center text-[var(--primary-color)]">Shop</h1>

    <button id="filterToggle" class="lg:hidden mb-4 px-4 py-2 bg-[var(--primary-color)] text-white rounded-md">Filters</button>

    <div class="flex flex-col lg:flex-row gap-8">

        <aside id="ys-filter" class="w-full lg:w-1/4 bg-white p-4 rounded-lg shadow-md hidden lg:block lg:sticky lg:top-4">
            <h2 class="text-xl font-semibold mb-4">Filters</h2>

            <div class="mb-6">
                <h3 class="font-semibold mb-2">Categories</h3>
                <ul class="flex flex-col gap-2">
                    <li>
                        <a href="{% url 'shop' %}" class="block px-2 py-1 rounded-md {% if not selected_category %}bg-[var(--primary-color)] text-white{% else %}bg-gray-100{% endif %} hover:bg-[var(--primary-color)] hover:text-white transition">
                            All
                        </a>
                    </li>
                    {% for category in categories %}
                    <li>
                        <a href="?category={{ category.id }}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}" class="block px-2 py-1 rounded-md {% if selected_category == category.id %}bg-[var(--primary-color)] text-white{% else %}bg-gray-100{% endif %} hover:bg-[var(--primary-color)] hover:text-white transition">
                            {{ category.name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="mb-6">
                <h3 class="font-semibold mb-2">Price</h3>
                <form action="{% url 'shop' %}" method="get" class="flex flex-col gap-2">
                    {% if selected_category %}
                    <input type="hidden" name="category" value="{{ selected_category }}">
                    {% endif %}
                    <input type="number" name="min_price" placeholder="Min" value="{{ min_price|default:'' }}" class="px-3 py-2 border rounded-md focus:outline-none">
                    <input type="number" name="max_price" placeholder="Max" value="{{ max_price|default:'' }}" class="px-3 py-2 border rounded-md focus:outline-none">
                    <button type="submit" class="mt-2 px-4 py-2 bg-[var(--primary-color)] text-white rounded-md hover:bg-[var(--secondary-color)] transition">
                        Apply
                    </button>
                </form>
            </div>

            <div class="mb-6">
                <h3 class="font-semibold mb-2">Sort By</h3>
                <form action="{% url 'shop' %}" method="get">
                    {% if selected_category %}
                    <input type="hidden" name="category" value="{{ selected_category }}">
                    {% endif %}
                    {% if min_price %}
                    <input type="hidden" name="min_price" value="{{ min_price }}">
                    {% endif %}
                    {% if max_price %}
                    <input type="hidden" name="max_price" value="{{ max_price }}">
                    {% endif %}
                    <select name="sort_by" class="w-full px-3 py-2 border rounded-md focus:outline-none" onchange="this.form.submit()">
                        <option value="">Sort By</option>
                        <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                        <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                        <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Newest</option>
                    </select>
                </form>
            </div>
        </aside>

        <div class="flex-1">

            <form action="{% url 'shop' %}" method="get" class="mb-6 flex flex-col sm:flex-row gap-3">
                <div class="relative flex-1">
                    <input id="voice-search-input" type="text" name="q" value="{{ query|default:'' }}" placeholder="Search products..." class="w-full px-4 py-3 border rounded-md focus:outline-none pr-10">
                    <button type="button" id="voice-search-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-[var(--primary-color)]">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm3 14a7 7 0 005.8-3.2L16 14.8V16a1 1 0 102 0v-2a1 1 0 00-1-1h-1.2A8 8 0 0110 18z" clip-rule="evenodd" />
                            <path d="M12 14.12a1 1 0 01.4-.41V11a1 1 0 112 0v2.71a1 1 0 01-1.4.41zM8 14.12A1 1 0 017.6 11V8a1 1 0 112 0v3.12a1 1 0 01-1.6.41z" />
                        </svg>
                    </button>
                </div>
                
                {% if selected_category %}
                <input type="hidden" name="category" value="{{ selected_category }}">
                {% endif %}
                {% if min_price %}
                <input type="hidden" name="min_price" value="{{ min_price }}">
                {% endif %}
                {% if max_price %}
                <input type="hidden" name="max_price" value="{{ max_price }}">
                {% endif %}
                {% if sort_by %}
                <input type="hidden" name="sort_by" value="{{ sort_by }}">
                {% endif %}
                <button type="submit" class="px-6 py-3 bg-[var(--primary-color)] text-white rounded-md hover:bg-[var(--secondary-color)] transition font-medium">
                    Search
                </button>
            </form>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6">
                {% for product in products %}
                <div class="bg-white shadow rounded-lg p-4 hover:shadow-2xl transition flex flex-col">
                    {% if product.images.exists %}
                        <img src="{{ product.images.first.image.url }}" alt="{{ product.title }}" class="w-full h-48 object-contain mb-2">
                    {% elif product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.title }}" class="w-full h-48 object-contain mb-2">
                    {% else %}
                        <div class="h-48 w-full bg-gray-200 flex items-center justify-center rounded-md mb-4 text-gray-500">
                            No Image
                        </div>
                    {% endif %}
                    <h3 class="font-semibold text-lg text-gray-800 mt-2">{{ product.title }}</h3>
                    <p class="text-gray-600 font-medium mt-1">â‚¹{{ product.price }}</p>
                    <p class="text-gray-500 text-sm mt-1">{{ product.category.name }}</p>
                    <div class="mt-auto flex gap-2 pt-4">
                        <a href="{% url 'product_detail' product.id %}" class="flex-1 text-center px-3 py-2 border border-gray-300 rounded-md hover:bg-[var(--primary-color)] hover:text-white transition">
                            View
                        </a>
                        <a href="{% url 'add_to_cart' product.id %}" class="flex-1 text-center px-3 py-2 bg-[var(--primary-color)] text-white rounded-md hover:bg-[var(--secondary-color)] transition">
                            Add to Cart
                        </a>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-10">
                    <h2 class="text-2xl font-semibold text-gray-700">No products found.</h2>
                    <p class="text-gray-500 mt-2">Try adjusting your filters or search terms.</p>
                </div>
                {% endfor %}
            </div>

            {% if page_obj %}
            <div class="mt-8 flex justify-center gap-2 flex-wrap">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if query %}&q={{ query }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 transition">Previous</a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <span class="px-3 py-1 bg-[var(--primary-color)] text-white rounded-md">{{ num }}</span>
                    {% else %}
                    <a href="?page={{ num }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if query %}&q={{ query }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 transition">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if query %}&q={{ query }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 transition">Next</a>
                {% endif %}
            </div>
            {% endif %}

        </div>
    </div>
</div>

<script>
    // Toggle filter sidebar on mobile
    const filter = document.getElementById('ys-filter');
    const toggle = document.getElementById('filterToggle');

    toggle.addEventListener('click', () => {
        filter.classList.toggle('hidden');
    });

    // Voice Search Functionality
    const voiceSearchBtn = document.getElementById('voice-search-btn');
    const voiceSearchInput = document.getElementById('voice-search-input');

    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.continuous = false; // Stop after a single phrase
        recognition.lang = 'en-US'; // Set language

        voiceSearchBtn.addEventListener('click', () => {
            voiceSearchInput.placeholder = 'Listening...';
            recognition.start();
        });

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            voiceSearchInput.value = transcript;
            voiceSearchInput.placeholder = 'Search products...';
            voiceSearchBtn.closest('form').submit();
        };

        recognition.onend = () => {
            voiceSearchInput.placeholder = 'Search products...';
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            voiceSearchInput.placeholder = 'Search products...';
            alert('Voice search failed. Please try again.');
        };
    } else {
        voiceSearchBtn.style.display = 'none'; // Hide the button if not supported
        console.warn('Web Speech API is not supported in this browser.');
    }
</script>
{% endblock %}